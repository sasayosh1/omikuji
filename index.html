<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#b91c1c" />
  <meta name="description" content="2026å¹´åˆå¹´ï¼ˆã†ã¾ã©ã—ï¼‰ãŠã¿ãã˜ã€‚æ–°å¹´ã®é‹æ°—ã‚’ãŠã—ã‚ƒã‚Œãªãƒ‡ã‚¶ã‚¤ãƒ³ã§ã€‚">
  <title>åˆå¹´ãŠã¿ãã˜ 2026 | é–‹é‹æ‹›ç¦</title>
  <style>
    :root {
      --red: #b91c1c;
      --red-light: #ef4444;
      --gold: #a16207;
      --gold-light: #f59e0b;
      --bg: #fffaf5;
      --ink: #1e293b;
      --muted: #64748b;
      --card-bg: rgba(255, 255, 255, 0.95);
      --border: rgba(185, 28, 28, 0.15);
      --shadow: 0 12px 40px -10px rgba(0, 0, 0, 0.1);
      --radius: 24px;
      --font: ui-sans-serif, system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    }

    /* Accessibility: Reduced Motion */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      padding: 0;
      color: var(--ink);
      font-family: var(--font);
      background-color: var(--bg);
      background-image: 
        radial-gradient(circle at 20% 20%, rgba(185, 28, 28, 0.05), transparent 40%),
        radial-gradient(circle at 80% 80%, rgba(161, 98, 7, 0.05), transparent 40%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
    }

    /* å’ŒæŸ„ï¼šéº»ã®è‘‰æ¨¡æ§˜é¢¨ï¼ˆè»½é‡CSSï¼‰ */
    .pattern-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: -1;
      opacity: 0.4;
      background-image: radial-gradient(var(--border) 1px, transparent 1px);
      background-size: 24px 24px;
    }

    .container {
      width: 100%;
      max-width: 480px;
      padding: 24px 16px 40px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    header {
      text-align: center;
      padding: 20px 0;
    }

    .badge {
      display: inline-block;
      background: var(--red);
      color: white;
      padding: 4px 16px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 14px;
      letter-spacing: 0.1em;
      margin-bottom: 12px;
      box-shadow: 0 4px 12px rgba(185, 28, 28, 0.3);
    }

    h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 900;
      color: var(--red);
      letter-spacing: -0.02em;
    }

    .subtitle {
      color: var(--muted);
      font-size: 14px;
      font-weight: 600;
      margin-top: 4px;
    }

    /* Main Card */
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      border: 1px solid white;
      box-shadow: var(--shadow);
      padding: 24px;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    /* Lottery Interaction Area */
    .lottery-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
      padding: 20px 0;
    }

    .omikuji-box-wrapper {
      position: relative;
      width: 140px;
      height: 200px;
      perspective: 1000px;
    }

    .omikuji-box {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--red), #8b0000);
      border-radius: 12px;
      position: relative;
      display: flex;
      justify-content: center;
      box-shadow: 0 20px 40px -10px rgba(139, 0, 0, 0.4);
      border: 2px solid var(--gold);
    }

    .omikuji-box::after {
      content: "åˆ";
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      color: var(--gold);
      font-size: 64px;
      font-weight: 900;
      opacity: 0.8;
    }

    /* Shaking Animation */
    .shaking {
      animation: shake 0.5s infinite;
    }

    @keyframes shake {
      0% { transform: rotate(0) translate(0, 0); }
      25% { transform: rotate(5deg) translate(2px, -2px); }
      50% { transform: rotate(0) translate(-2px, 2px); }
      75% { transform: rotate(-5deg) translate(2px, 2px); }
      100% { transform: rotate(0) translate(0, 0); }
    }

    /* The Result Paper */
    .paper {
      position: absolute;
      top: 0;
      left: 50%;
      width: 90px;
      height: 140px;
      background: white;
      border: 1px solid #ddd;
      transform: translateX(-50%) translateY(0);
      z-index: -1;
      opacity: 0;
      transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .paper.emerge {
      transform: translateX(-50%) translateY(-120px) rotate(-5deg);
      opacity: 1;
      z-index: 10;
    }

    /* Result Details Fade-in */
    .result-view {
      display: none;
      animation: fadeIn 0.8s ease forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fortune-title {
      font-size: 56px;
      font-weight: 1000;
      color: var(--red);
      text-align: center;
      margin: 12px 0;
      letter-spacing: 0.1em;
      text-shadow: 2px 2px 0px rgba(185, 28, 28, 0.1);
    }

    .fortune-lead {
      font-size: 18px;
      font-weight: 800;
      text-align: center;
      color: var(--ink);
      line-height: 1.6;
      margin-bottom: 24px;
      padding: 0 10px;
    }

    .grid-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 24px;
    }

    .detail-item {
      background: #f8fafc;
      padding: 14px;
      border-radius: 16px;
      border: 1px solid #f1f5f9;
    }

    .detail-label {
      font-size: 11px;
      font-weight: 800;
      color: var(--muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .detail-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--ink);
      line-height: 1.4;
    }

    .actions-list {
      background: linear-gradient(to bottom right, #fffdfa, #fefce8);
      padding: 18px;
      border-radius: 20px;
      border: 1px solid #fef08a;
      margin-bottom: 24px;
    }

    .actions-title {
      font-size: 13px;
      font-weight: 900;
      color: var(--gold);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .action-row {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 8px;
      display: flex;
      gap: 10px;
    }

    .action-row::before {
      content: "â€¢";
      color: var(--gold);
    }

    /* Buttons */
    .button-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .btn {
      width: 100%;
      height: 60px;
      border: none;
      border-radius: 30px;
      font-family: var(--font);
      font-size: 17px;
      font-weight: 800;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .btn-primary {
      background: var(--red);
      color: white;
      box-shadow: 0 8px 24px -6px rgba(185, 28, 28, 0.4);
    }

    .btn-primary:active { transform: scale(0.96); box-shadow: 0 4px 12px -4px rgba(185, 28, 28, 0.4); }

    .btn-secondary {
      background: white;
      color: var(--ink);
      border: 1px solid #e2e8f0;
    }

    .btn-secondary:active { transform: scale(0.96); background: #f8fafc; }

    /* Settings / Toggles */
    .settings {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 10px;
    }

    .toggle-btn {
      background: white;
      border: 1px solid #e2e8f0;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .toggle-btn.active {
      border-color: var(--red);
      color: var(--red);
      background: #fef2f2;
    }

    footer {
      text-align: center;
      padding: 40px 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.6;
    }

    /* Confetti Canvas */
    #canvas {
      position: fixed;
      inset: 0;
      z-index: 100;
      pointer-events: none;
    }

    /* "Horse Quote" display */
    .horse-quote {
      font-style: italic;
      color: var(--gold);
      text-align: center;
      margin-top: 12px;
      font-weight: 700;
      font-size: 14px;
    }
  </style>
</head>
<body>

<div class="pattern-bg"></div>
<canvas id="canvas"></canvas>

<div class="container">
  <header>
    <div class="badge">2026 ä¸™åˆ</div>
    <h1>åˆå¹´ãŠã¿ãã˜</h1>
    <p class="subtitle">ä»Šæ—¥ã¯ã©ã‚“ãªä¸€æ­©ã‚’è¸ã¿å‡ºã™ï¼Ÿ</p>
  </header>

  <div class="card" id="mainCard">
    <!-- Initial State -->
    <div id="lotteryView" class="lottery-area">
      <div class="omikuji-box-wrapper">
        <div id="omikujiBox" class="omikuji-box"></div>
        <div id="paper" class="paper">
          <div style="font-size:10px; font-weight:900; color:var(--red)">é–‹é‹</div>
          <div style="flex:1; display:flex; align-items:center; font-weight:900; font-size:12px; writing-mode:vertical-rl">å¤§å‰</div>
        </div>
      </div>
      <div class="button-group" style="width: 100%">
        <button class="btn btn-primary" id="lotteryBtn">ğŸ´ ãŠã¿ãã˜ã‚’å¼•ã</button>
      </div>
    </div>

    <!-- Result State -->
    <div id="resultView" class="result-view">
      <div style="text-align: center; font-size: 12px; font-weight: 800; color: var(--muted);" id="resultDate">2026.01.01</div>
      <div class="fortune-title" id="fortuneTitle">å¤§å‰</div>
      <p class="fortune-lead" id="fortuneLead">
        å‹¢ã„ã‚ˆãé§†ã‘æŠœã‘ã‚‹ä¸€å¹´ã€‚è¿·ã‚ãšé€²ã‚ã°é“ã¯é–‹ã‘ã¾ã™ã€‚
      </p>

      <div class="grid-details">
        <div class="detail-item">
          <div class="detail-label">ä»•äº‹ãƒ»å­¦ã³</div>
          <div class="detail-value" id="resWork">æº–å‚™ãŒæ•´ã„ã€æˆæœãŒå‡ºã‚‹æ™‚</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">æ‹æ„›ãƒ»äºº</div>
          <div class="detail-value" id="resLove">ç´ ç›´ãªæ°—æŒã¡ãŒå‰ã‚’å‘¼ã¶</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">é‡‘é‹</div>
          <div class="detail-value" id="resMoney">æ¬²ã‚’å¼µã‚‰ãšã«ã€å¾ªç’°ã•ã›ã‚‹</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">å¥åº·</div>
          <div class="detail-value" id="resHealth">æ·±å‘¼å¸ã§ãƒªã‚ºãƒ ã‚’æ•´ãˆã¦</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ </div>
          <div class="detail-value" id="resItem">æ–°ã—ã„ãƒãƒ¼ãƒˆ</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼</div>
          <div class="detail-value" id="resColor">æœ±è‰²</div>
        </div>
      </div>

      <div class="actions-list">
        <div class="actions-title">âœ¨ ä»Šæ—¥ã®é–‹é‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
        <div id="resActions">
          <!-- Rows will be injected -->
        </div>
      </div>

      <div class="horse-quote" id="horseQuote">ã€Œé¢¨ã‚’åˆ‡ã‚Šã€åƒé‡Œã‚’èµ°ã‚‹å‹¢ã„ã§ã€</div>

      <div class="button-group" style="margin-top: 32px">
        <button class="btn btn-primary" id="shareBtn">ğŸ“© çµæœã‚’ã‚·ã‚§ã‚¢ã™ã‚‹</button>
        <button class="btn btn-secondary" id="resetBtn">â†©ï¸ ã‚‚ã†ä¸€åº¦å¼•ã</button>
      </div>
    </div>
  </div>

  <div class="settings">
    <button class="toggle-btn active" id="soundToggle">ğŸ”Š éŸ³</button>
    <button class="toggle-btn active" id="vibeToggle">ğŸ“³ ãƒã‚¤ãƒ–</button>
    <button class="toggle-btn active" id="effectToggle">âœ¨ æ¼”å‡º</button>
  </div>

  <footer>
    <p>â€»æœ¬ãŠã¿ãã˜ã«ã€Œå‡¶ãƒ»å¤§å‡¶ã€ã¯å«ã¾ã‚Œã¾ã›ã‚“ã€‚<br>å‰å‘ããªä¸€å¹´ã«ãªã‚Šã¾ã™ã‚ˆã†ã«ã€‚</p>
    <p>&copy; 2026 Omikuji Project</p>
  </footer>
</div>

<script>
  // --- Data ---
  const fortunes = [
    { name: "å¤§å‰", lead: "æœ€é«˜ã®ã‚¹ã‚¿ãƒ¼ãƒˆã€‚ã‚ãªãŸã®æƒ…ç†±ãŒå‘¨ã‚Šã‚’å‹•ã‹ã—ã€åƒé‡Œã‚’é§†ã‘ã‚‹åé¦¬ã®ã‚ˆã†ãªå‹¢ã„ã§é€²ã‚ã‚‹æ™‚ã§ã™ã€‚", weight: 15, intensity: 3 },
    { name: "ä¸­å‰", lead: "è¿½ã„é¢¨ãŒå¹ã„ã¦ã„ã¾ã™ã€‚ä¸å¯§ãªæº–å‚™ãŒå¤§ããªå®Ÿã‚Šã¸ã¨ç¹‹ãŒã‚Šã¾ã™ã€‚ä¸€æ­©ãšã¤ç€å®Ÿã«é€²ã¿ã¾ã—ã‚‡ã†ã€‚", weight: 25, intensity: 2 },
    { name: "å°å‰", lead: "ç©ã‚„ã‹ã§è‰¯ã„é‹æ°—ã€‚æ—¥å¸¸ã®å°ã•ãªå¹¸ã›ã«æ°—ã¥ãã“ã¨ã§ã€ã•ã‚‰ã«é‹æ°—ãŒé–‹ã‘ã¦ã„ãã¾ã™ã€‚", weight: 30, intensity: 1 },
    { name: "å‰",   lead: "èª å®Ÿã•ãŒéµã€‚å½“ãŸã‚Šå‰ã®ã“ã¨ã‚’å¤§åˆ‡ã«ã™ã‚Œã°ã€æœ›ã‚“ã§ã„ãŸçµæœã¯è‡ªç„¶ã¨ä»˜ã„ã¦ãã¾ã™ã€‚", weight: 20, intensity: 1 },
    { name: "æœ«å‰", lead: "ã“ã‚Œã‹ã‚‰ã®ä¼¸ã³ä»£ãŒå¤§ãã„é‹å‹¢ã€‚ä»Šã¯è¶³å…ƒã‚’å›ºã‚ã¦ã€æ¥ã‚‹ã¹ãé£›èºã®æ™‚ã«å‚™ãˆã¾ã—ã‚‡ã†ã€‚", weight: 10, intensity: 1 }
  ];

  const workItems = ["ç²˜ã‚Šå¼·ã•ãŒè©•ä¾¡ã•ã‚Œã‚‹","æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’æ›¸ãç•™ã‚ã¦","åˆå‰ä¸­ã®æ±ºæ–­ãŒå‰","å¾©ç¿’ãŒæœ€å¤§ã®æ­¦å™¨ã«ãªã‚‹","çŸ­æ™‚é–“ã®é›†ä¸­ã‚’ç¹°ã‚Šè¿”ã™"];
  const loveItems = ["æ„Ÿè¬ã‚’è¨€è‘‰ã«ã—ã¦ä¼ãˆã‚‹","ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ä¼šè©±ã‚’æ¥½ã—ã‚€","èãæ‰‹ã«å›ã‚‹ã¨ç™ºè¦‹ãŒã‚ã‚‹","æ‡ã‹ã—ã„å‹ã«é€£çµ¡ã‚‚å‰","è‡ªåˆ†ã‚’ç£¨ãæ™‚é–“ãŒé­…åŠ›ã«"];
  const moneyItems = ["å°ã•ãªç¯€ç´„ãŒå¤§ããªè“„ãˆã«","é•·ãä½¿ãˆã‚‹ã‚‚ã®ã‚’é¸ã¶","ãŠè²¡å¸ƒã‚’ã™ã£ãã‚Šæ•´ç†","è‡ªå·±æŠ•è³‡ã«ã¯æƒœã—ã¿ãªã","å‹Ÿé‡‘ã‚„è´ˆã‚Šç‰©ãŒå·¡ã‚Šå·¡ã‚‹"];
  const healthItems = ["ã‚¹ãƒˆãƒ¬ãƒƒãƒã§ä½“ã‚’ã»ãã™","æ—¬ã®é£Ÿæã‚’å‘³ã‚ã†","æ—©å¯æ—©èµ·ããŒé‹æ°—ã‚’å‘¼ã¶","æ·±å‘¼å¸ã§å¿ƒã‚’è½ã¡ç€ã‹ã›ã‚‹","æ°´ã‚’ä¸€å£å¤šã‚ã«é£²ã‚€"];
  const items = ["æ–°ã—ã„ç­†è¨˜å…·","å¹²æ”¯ã®ã‚¹ãƒˆãƒ©ãƒƒãƒ—","æ‡ç´™","ãŠå®ˆã‚Š","èµ¤ã„ãƒãƒ³ã‚«ãƒ","ãŠæ°—ã«å…¥ã‚Šã®ãŠé¦™","æœ¬","æœ¨è£½ã®å°ç‰©"];
  const colors = ["æœ±è‰²ï¼ˆã—ã‚…ã„ã‚ï¼‰","é‡‘èŒ¶ï¼ˆãã‚“ã¡ã‚ƒï¼‰","ç™½èŒæœ¨ï¼ˆã—ã‚ã‚‚ãˆãï¼‰","è—é¼ ï¼ˆã‚ã„ã­ãšï¼‰","ç”Ÿæˆè‰²ï¼ˆããªã‚Šã„ã‚ï¼‰","è‹¥è‰è‰²"];
  const actions = [
    "æœä¸€ç•ªã«çª“ã‚’é–‹ã‘ã¦æ›æ°—ã™ã‚‹", "é´ã‚’ä¸¦ã¹ã¦æƒãˆã‚‹", "é¡ã‚’è¦‹ã¦ç¬‘é¡”ã®ç·´ç¿’ã‚’ã™ã‚‹", 
    "ãƒ‡ã‚¹ã‚¯ã®å‘¨ã‚Šã‚’1ç®‡æ‰€ã ã‘æƒé™¤ã™ã‚‹", "æ·±å‘¼å¸ã‚’3å›ã‚†ã£ãã‚Šè¡Œã†", 
    "ä»Šæ—¥æ„Ÿè¬ã—ãŸã„äººã‚’ä¸€äººæ€ã„æµ®ã‹ã¹ã‚‹", "èƒŒç­‹ã‚’ä¼¸ã°ã—ã¦æ­©ã", 
    "æ¸©ã‹ã„é£²ã¿ç‰©ã‚’ã‚†ã£ãã‚Šå‘³ã‚ã†"
  ];
  const horseQuotes = [
    "ã€Œé¢¨ã‚’åˆ‡ã‚Šã€åƒé‡Œã‚’èµ°ã‚‹å‹¢ã„ã§ã€",
    "ã€Œå¤©é«˜ãã€é£›èºã®ä¸€æ­©ã‚’åˆ»ã‚€å¹´ã€",
    "ã€Œå¤§åœ°ã‚’è¹´ã‚Šã€æœªæ¥ã¸é§†ã‘æŠœã‘ã‚ã€",
    "ã€Œé»„é‡‘ã®ãŸã¦ãŒã¿ã‚’æºã‚‰ã—ã€å…‰ã‚’æ´ã‚€ã€",
    "ã€Œç¾¤ã‚Œã‚’ç‡ã„ã‚‹ç‹è€…ã®å¦‚ãé¢¨æ ¼ã‚’ã€"
  ];

  // --- Configuration & State ---
  let state = {
    sound: true,
    vibration: true,
    effects: true,
    result: null
  };

  const LS_KEY = 'omikuji_2026_result';

  // --- Utils ---
  const $ = (id) => document.getElementById(id);
  const rnd = (arr) => arr[Math.floor(Math.random() * arr.length)];
  
  const getWeightedFortune = () => {
    const total = fortunes.reduce((sum, f) => sum + f.weight, 0);
    let r = Math.random() * total;
    for (const f of fortunes) {
      r -= f.weight;
      if (r <= 0) return f;
    }
    return fortunes[0];
  };

  // --- Web Audio (Synthetic Drumroll & Ding) ---
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const playSound = (type) => {
    if (!state.sound) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();
    
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);

    if (type === 'roll') {
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(100, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 1.5);
      gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
      gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1.5);
      osc.start();
      osc.stop(audioCtx.currentTime + 1.5);
    } else if (type === 'ding') {
      osc.type = 'sine';
      osc.frequency.setValueAtTime(880, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.5);
      gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.5);
    }
  };

  // --- Vibration ---
  const vibrate = (ms) => {
    if (state.vibration && "vibrate" in navigator) {
      navigator.vibrate(ms);
    }
  };

  // --- Confetti ---
  const canvas = $("canvas");
  const ctx = canvas.getContext("2d");
  let confetti = [];
  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  function spawnConfetti(count) {
    if (!state.effects) return;
    const colorsList = ["#b91c1c", "#a16207", "#facc15", "#ffffff"];
    for (let i = 0; i < count; i++) {
      confetti.push({
        x: Math.random() * canvas.width,
        y: -20,
        r: Math.random() * 6 + 4,
        d: Math.random() * 10 + 2,
        color: rnd(colorsList),
        tilt: Math.random() * 10 - 5
      });
    }
  }

  function updateConfetti() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    confetti.forEach((p, i) => {
      p.y += p.d;
      p.x += Math.sin(p.y / 20);
      ctx.beginPath();
      ctx.fillStyle = p.color;
      ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      ctx.fill();
      if (p.y > canvas.height) confetti.splice(i, 1);
    });
    requestAnimationFrame(updateConfetti);
  }
  updateConfetti();

  // --- Core Logic ---
  const saveResult = (res) => {
    localStorage.setItem(LS_KEY, JSON.stringify({
      ...res,
      date: new Date().toDateString()
    }));
  };

  const loadResult = () => {
    const saved = localStorage.getItem(LS_KEY);
    if (saved) {
      const parsed = JSON.parse(saved);
      if (parsed.date === new Date().toDateString()) {
        return parsed;
      }
    }
    return null;
  };

  const generateResult = () => {
    const f = getWeightedFortune();
    // Pick 3 unique actions
    let actionSet = new Set();
    while(actionSet.size < 3) actionSet.add(rnd(actions));

    return {
      fortune: f.name,
      lead: f.lead,
      intensity: f.intensity,
      work: rnd(workItems),
      love: rnd(loveItems),
      money: rnd(moneyItems),
      health: rnd(healthItems),
      item: rnd(items),
      color: rnd(colors),
      actions: Array.from(actionSet),
      quote: rnd(horseQuotes)
    };
  };

  const renderResult = (res) => {
    $("lotteryView").style.display = "none";
    $("resultView").style.display = "block";
    
    $("fortuneTitle").textContent = res.fortune;
    $("fortuneLead").textContent = res.lead;
    $("resWork").textContent = res.work;
    $("resLove").textContent = res.love;
    $("resMoney").textContent = res.money;
    $("resHealth").textContent = res.health;
    $("resItem").textContent = res.item;
    $("resColor").textContent = res.color;
    $("horseQuote").textContent = res.quote;
    
    const actionContainer = $("resActions");
    actionContainer.innerHTML = res.actions.map(a => `<div class="action-row">${a}</div>`).join("");
    
    const now = new Date();
    $("resultDate").textContent = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')}`;

    if (state.effects) {
      spawnConfetti(res.intensity * 40);
    }
  };

  const startLottery = () => {
    const box = $("omikujiBox");
    const paper = $("paper");
    const btn = $("lotteryBtn");
    
    btn.disabled = true;
    box.classList.add("shaking");
    playSound("roll");
    vibrate([100, 50, 100, 50, 100]);

    setTimeout(() => {
      box.classList.remove("shaking");
      paper.classList.add("emerge");
      playSound("ding");
      vibrate(200);

      setTimeout(() => {
        const result = generateResult();
        state.result = result;
        saveResult(result);
        renderResult(result);
      }, 800);
    }, 1500);
  };

  // --- Shared & Clipboard ---
  const share = async () => {
    const res = state.result;
    if (!res) return;
    const text = `ğŸ´ 2026å¹´åˆå¹´ãŠã¿ãã˜ã€${res.fortune}ã€‘\n${res.lead}\nãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼ï¼š${res.color}\né–‹é‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼š${res.actions[0]} ä»–\n#ãŠã¿ãã˜ #2026å¹´ #åˆå¹´`;
    const url = window.location.href;

    if (navigator.share) {
      try {
        await navigator.share({ title: "åˆå¹´ãŠã¿ãã˜ 2026", text, url });
      } catch (err) {}
    } else {
      try {
        await navigator.clipboard.writeText(text + "\n" + url);
        alert("çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼LINEã‚„SNSã«è²¼ã‚Šä»˜ã‘ã¦ã­ ğŸ´");
      } catch (err) {
        alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    }
  };

  // --- Events ---
  $("lotteryBtn").addEventListener("click", startLottery);
  $("shareBtn").addEventListener("click", share);
  
  $("resetBtn").addEventListener("click", () => {
    if (confirm("ä»Šæ—¥ã®çµæœã‚’æ¶ˆã—ã¦ã€ã‚‚ã†ä¸€åº¦å¼•ãã¾ã™ã‹ï¼Ÿ")) {
      localStorage.removeItem(LS_KEY);
      location.reload();
    }
  });

  // Toggles
  const handleToggle = (id, field) => {
    $(id).addEventListener("click", (e) => {
      state[field] = !state[field];
      e.target.classList.toggle("active");
      vibrate(50);
    });
  };
  handleToggle("soundToggle", "sound");
  handleToggle("vibeToggle", "vibration");
  handleToggle("effectToggle", "effects");

  // Init
  window.onload = () => {
    const saved = loadResult();
    if (saved) {
      state.result = saved;
      renderResult(saved);
    }
  };

</script>
</body>
</html>
